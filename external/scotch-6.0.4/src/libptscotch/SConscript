#Copyright (C) 2015 Applied CCM
import subprocess
import os
Import('globalEnv')

# Clone the global environment so changes made he are not pass onto subsequent 
# libraries
ptscotchEnv = globalEnv.Clone()

ptscotchEnv.Append(CCFLAGS = '')

#===============================================================================
# Additions to include directories for this library
#===============================================================================
lib_inc = ['../libscotch', ptscotchEnv['MPI_INC']]
ptscotchEnv.Prepend(CPPPATH = lib_inc)

#===============================================================================
# Additions to link libraries for this library
#===============================================================================
lib_link = ['ptscotcherr','ptscotcherrexit','z'] 
ptscotchEnv.Append(LIBS = lib_link)

#===============================================================================
# Sources for this library
#===============================================================================
src_files = Split("""
bdgraph.c	
bdgraph_bipart_bd.c
bdgraph_bipart_df.c
bdgraph_bipart_ex.c	
bdgraph_bipart_ml.c
bdgraph_bipart_sq.c
bdgraph_bipart_st.c
bdgraph_bipart_zr.c
bdgraph_check.c
bdgraph_gather_all.c
bdgraph_store.c
comm.c
dgraph.c
dgraph_allreduce.c
dgraph_band.c
dgraph_build.c	
dgraph_build_grid3d.c
dgraph_build_hcub.c	
dgraph_check.c
dgraph_coarsen.c
dgraph_fold.c
dgraph_fold_comm.c
dgraph_fold_dup.c
dgraph_gather.c	
dgraph_gather_all.c
dgraph_ghst.c
dgraph_halo.c
dgraph_induce.c
dgraph_io_load.c
dgraph_io_save.c
dgraph_match.c	
dgraph_match_sync_coll.c
dgraph_match_sync_ptop.c
dgraph_match_check.c
dgraph_redist.c
dgraph_scatter.c
dgraph_view.c
dmapping.c
dmapping_io.c
dorder.c
dorder_gather.c	
dorder_io.c	
dorder_io_block.c
dorder_io_tree.c
dorder_perm.c
dorder_tree_dist.c
hdgraph.c
hdgraph_check.c
hdgraph_fold.c
hdgraph_gather.c
hdgraph_induce.c
hdgraph_order_nd.c
hdgraph_order_si.c
hdgraph_order_sq.c
hdgraph_order_st.c
kdgraph.c
kdgraph_map_rb.c
kdgraph_map_rb_map.c
kdgraph_map_rb_part.c
kdgraph_map_st.c
library_dgraph.c
library_dgraph_f.c
library_dgraph_band.c
library_dgraph_band_f.c
library_dgraph_build.c
library_dgraph_build_f.c
library_dgraph_build_grid3d.c
library_dgraph_build_grid3d_f.c
library_dgraph_check.c
library_dgraph_check_f.c
library_dgraph_coarsen.c
library_dgraph_coarsen_f.c
library_dgraph_gather.c	
library_dgraph_gather_f.c
library_dgraph_grow.c
library_dgraph_halo.c
library_dgraph_halo_f.c	
library_dgraph_induce.c
library_dgraph_io_load.c
library_dgraph_io_load_f.c	
library_dgraph_io_save.c
library_dgraph_io_save_f.c
library_dgraph_map.c
library_dgraph_map_f.c
library_dgraph_map_view.c
library_dgraph_map_view_f.c
library_dgraph_order.c
library_dgraph_order_f.c
library_dgraph_order_gather.c
library_dgraph_order_gather_f.c	
library_dgraph_order_io.c
library_dgraph_order_io_f.c
library_dgraph_order_io_block.c	
library_dgraph_order_io_block_f.c
library_dgraph_order_perm.c
library_dgraph_order_perm_f.c
library_dgraph_order_tree_dist.c
library_dgraph_order_tree_dist_f.c
library_dgraph_redist.c
library_dgraph_redist_f.c
library_dgraph_scatter.c
library_dgraph_scatter_f.c
library_dgraph_stat.c
library_dgraph_stat_f.c	
library_dmapping.c
library_dorder.c
vdgraph.c
vdgraph_check.c	
vdgraph_gather_all.c
vdgraph_separate_bd.c
vdgraph_separate_df.c
vdgraph_separate_ml.c
vdgraph_separate_sq.c
vdgraph_separate_st.c
vdgraph_separate_zr.c
vdgraph_store.c
../libscotch/arch.c
../libscotch/arch_cmplt.c
../libscotch/arch_cmpltw.c
../libscotch/arch_dist.c
../libscotch/arch_deco.c	
../libscotch/arch_hcub.c
../libscotch/arch_mesh.c
../libscotch/arch_tleaf.c
../libscotch/arch_torus.c
../libscotch/arch_vcmplt.c
../libscotch/arch_vhcub.c
../libscotch/bgraph.c
../libscotch/bgraph_bipart_bd.c
../libscotch/bgraph_bipart_df.c
../libscotch/bgraph_bipart_ex.c
../libscotch/bgraph_bipart_fm.c
../libscotch/bgraph_bipart_gg.c	
../libscotch/bgraph_bipart_gp.c	
../libscotch/bgraph_bipart_ml.c	
../libscotch/bgraph_bipart_st.c
../libscotch/bgraph_bipart_zr.c	
../libscotch/bgraph_store.c
../libscotch/common_integer.c
../libscotch/common_memory.c
../libscotch/common_string.c	
../libscotch/common_thread.c
../libscotch/gain.c
../libscotch/graph.c
../libscotch/graph_band.c
../libscotch/graph_coarsen.c
../libscotch/graph_induce.c
../libscotch/graph_match.c
../libscotch/hall_order_hd.c
../libscotch/hall_order_hf.c
../libscotch/hall_order_hx.c
../libscotch/hgraph.c	
../libscotch/hgraph_induce.c
../libscotch/hgraph_order_bl.c
../libscotch/hgraph_order_cp.c
../libscotch/hgraph_order_gp.c
../libscotch/hgraph_order_kp.c
../libscotch/hgraph_order_hd.c
../libscotch/hgraph_order_hf.c
../libscotch/hgraph_order_hx.c
../libscotch/hgraph_order_nd.c
../libscotch/hgraph_order_si.c
../libscotch/hgraph_order_st.c
../libscotch/kgraph.c
../libscotch/kgraph_band.c
../libscotch/kgraph_map_bd.c
../libscotch/kgraph_map_cp.c
../libscotch/kgraph_map_df.c
../libscotch/kgraph_map_ex.c
../libscotch/kgraph_map_fm.c
../libscotch/kgraph_map_ml.c
../libscotch/kgraph_map_rb.c
../libscotch/kgraph_map_rb_map.c
../libscotch/kgraph_map_rb_part.c
../libscotch/kgraph_map_st.c
../libscotch/kgraph_store.c
../libscotch/library_arch.c
../libscotch/library_parser.c
../libscotch/mapping.c
../libscotch/parser.c
../libscotch/order.c
../libscotch/order_io.c
../libscotch/last_resort/parser_ll.c 
../libscotch/last_resort/parser_yy.c
../libscotch/vgraph.c
../libscotch/vgraph_separate_bd.c
../libscotch/vgraph_separate_es.c
../libscotch/vgraph_separate_fm.c
../libscotch/vgraph_separate_gg.c
../libscotch/vgraph_separate_gp.c
../libscotch/vgraph_separate_ml.c
../libscotch/vgraph_separate_st.c
../libscotch/vgraph_separate_vw.c
../libscotch/vgraph_separate_zr.c
../libscotch/vgraph_store.c
  """)

#===============================================================================
# Build this library
#===============================================================================
libptscotch = ptscotchEnv.SharedLibrary(target = 'libptscotch',
source = src_files)

#===============================================================================
# Install this library
#===============================================================================
install_dir = ptscotchEnv['LIB_PLATFORM_INSTALL']
ptscotchEnv.Alias('install', install_dir)
ptscotchEnv.Install(install_dir, libptscotch)

if (ptscotchEnv['WHICH_OS'] == "darwin"):

  ptscotchEnv.Append(SHLINKFLAGS ='-install_name @loader_path/../../../external/scotch-6.0.4/lib/libptscotch.dylib')
