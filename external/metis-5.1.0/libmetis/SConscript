#Copyright (C) 2014 Applied CCM
import subprocess
Import('globalEnv')

# Clone the global environment so changes made he are not pass onto subsequent 
# libraries
metisEnv = globalEnv.Clone()

metisEnv.Append(CXXFLAGS = '')

#===============================================================================
# Additions to include directories for this library
#===============================================================================
lib_inc = ['.','../GKlib']
metisEnv.Prepend(CPPPATH = lib_inc)

#===============================================================================
# Additions to link libraries for this library
#===============================================================================
lib_link = [''] 
metisEnv.Append(LIBS = lib_link)

#===============================================================================
# Sources for this library
#===============================================================================
src_files = Split("""
../GKlib/util.c
../GKlib/gkregex.c
../GKlib/graph.c
../GKlib/error.c
../GKlib/omp.c
../GKlib/io.c
../GKlib/fkvkselect.c
../GKlib/blas.c
../GKlib/pqueue.c
../GKlib/evaluate.c
../GKlib/b64.c
../GKlib/random.c
../GKlib/seq.c
../GKlib/mcore.c
../GKlib/itemsets.c
../GKlib/timers.c
../GKlib/csr.c
../GKlib/sort.c
../GKlib/getopt.c
../GKlib/rw.c
../GKlib/tokenizer.c
../GKlib/fs.c
../GKlib/htable.c
../GKlib/memory.c
../GKlib/string.c
../GKlib/pdb.c
util.c
graph.c
fortran.c
debug.c
options.c
auxapi.c
contig.c
mesh.c
kmetis.c
refine.c
frename.c
compress.c
timing.c
fm.c
mincover.c
stat.c
mmd.c
sfm.c
minconn.c
srefine.c
checkgraph.c
wspace.c
parmetis.c
meshpart.c
balance.c
kwayfm.c
coarsen.c
gklib.c
mcutil.c
initpart.c
bucketsort.c
separator.c
kwayrefine.c
pmetis.c
ometis.c
  """)

#===============================================================================
# Build this library
#===============================================================================
libmetis = metisEnv.SharedLibrary(target = 'libmetis',
source = src_files)

#===============================================================================
# Install this library
#===============================================================================
install_dir = metisEnv['LIB_PLATFORM_INSTALL']
metisEnv.Alias('install', install_dir)
metisEnv.Install(install_dir, libmetis)

if (metisEnv['WHICH_OS'] == "darwin"):

  metisEnv.Append(SHLINKFLAGS ='-install_name @' + metisEnv['LIB_PLATFORM_INSTALL'] + '/libmetis.dylib')
